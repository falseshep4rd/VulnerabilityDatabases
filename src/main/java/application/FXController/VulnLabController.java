package application.FXController;

import application.model.VulnLab;
import application.utils.OpenWebpage;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.input.KeyCode;
import javafx.scene.text.Text;
import lombok.Data;

import java.io.IOException;
import java.net.URISyntaxException;
import java.util.ArrayList;
import java.util.List;

@Data
public class VulnLabController {
    @FXML
    private TextField vulnLabSearch;
    @FXML
    private Label countVulnLab;
    @FXML
    private TableView<VulnLab> tableVulnLab;
    @FXML
    private Button btnGoToSiteVulnLab;
    @FXML
    private TableColumn<VulnLab, String> date;
    @FXML
    private TableColumn<VulnLab, String> name;
    @FXML
    private TableColumn<VulnLab, String> type;

    private List<VulnLab> list = new ArrayList<>();
    private String url;

    private MainController mainController;

    public void injectMainController(MainController mainController) {
        this.mainController = mainController;
    }

    @FXML
    public void vulnLabSearch() {
        vulnLabSearch.setOnKeyPressed(
                keyEvent -> {
                    if (keyEvent.getCode().equals(KeyCode.ENTER)) {
                        search(vulnLabSearch.getText());
                    }
                }
        );
    }

    @FXML
    public void vulnLabSearchIcon() {
        if (!vulnLabSearch.getText().isEmpty()) {
            search(vulnLabSearch.getText());
        }
    }


    @FXML
    private void handleClicks(ActionEvent actionEvent) throws IOException, URISyntaxException {
        if (actionEvent.getSource() == btnGoToSiteVulnLab && url != null) {
            OpenWebpage.openWebpage(url);
        }
    }

    public void search(String text) {
        VulnLab VulnLab = new VulnLab();
        list = VulnLab.vulnLabScrape(text);
        url = VulnLab.getURL();
        populateTable(list);
    }

    private void populateTable(List<VulnLab> list) {
        date.setCellValueFactory(new PropertyValueFactory<>("date"));
        name.setCellValueFactory(new PropertyValueFactory<>("name"));
        type.setCellValueFactory(new PropertyValueFactory<>("type"));

        ObservableList<VulnLab> data = FXCollections.observableList(list);
        tableVulnLab.setItems(data);
        setWrapCellFactory(date);
        setWrapCellFactory(name);
        setWrapCellFactory(type);
        int countResults = list.size();
        countVulnLab.setText(Integer.toString(countResults));
    }

    private void setWrapCellFactory(TableColumn<VulnLab, String> table) {
        table.setCellFactory(tablecol -> {
            TableCell<VulnLab, String> cell = new TableCell<>();
            Text text = new Text();
            cell.setGraphic(text);
            text.wrappingWidthProperty().bind(cell.widthProperty());
            text.textProperty().bind(cell.itemProperty());
            return cell;
        });
    }
}
